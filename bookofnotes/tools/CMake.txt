Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4

====== CMake ======

Uses a configuration file (''CMakeLists.txt'') to generate build files (Makefiles, ninja files, etc), then use native build tools to compile. The advantage is independence of build method, with enought care its possible to compile the same source with gcc on linux, mingw on windows, visual studio, codeblocks, etc.

The recommended building way is to create a separate directory for the build, then generate the files on that directory. For example:
{{{code: lang="sh" linenumbers="False"
mkdir build
cd build
cmake ..
make
}}}


===== Installing =====
https://cmake.org/download/

//Recommend to add CMake to PATH if not already//

**Windows**:
	download and install
	
**Linux**:
	download and run command
	./''cmake-<version>-Linux-x86_64.sh --prefix=/usr/local --exclude-subdir''


===== Basic usage =====
CMakeLists.txt:
{{{code: lang="cmake" linenumbers="False"
cmake_minimum_required(VERSION 2.8)

project(basic_cmake_example)

add_executable(basic_executable src/file1.cpp src/file2.cpp)
}}}


Building with make
{{{code: lang="sh" linenumbers="False"
mkdir build
cd build
cmake ..
make 
}}}


Building for debug and for release
{{{code: lang="sh" linenumbers="False"
mkdir debug
cd debug
cmake -DCMAKE_BUILD_TYPE=Debug ..

cd ..
mkdir release
cd release
cmake -DCMAKE_BUILD_TYPE=Release ..

# from within each folder just run make
make

# cmake can also be used here
cmake --build .

# from base folder you can use cmake like this
cd ..
cmake --build debug
cmake --build release
}}}


===== Command Line notes =====
{{{code: lang="sh" linenumbers="False"
# when building with make, the build commands are not show, to see them run like this
make VERBOSE=1

# it is also possible to add 'set( CMAKE_VERBOSE_MAKEFILE on )' to CMakeLists.xt

# build and profile with gprof
cmake -DCMAKE_CXX_FLAGS=-pg -DCMAKE_EXE_LINKER_FLAGS=-pg -DCMAKE_SHARED_LINKER_FLAGS=-pg <SOURCE_DIR>
make
./executable_name
# after your program finishes
gprof executable_name > report.txt 

}}}


===== CMakeLists.txt notes =====
{{{code: lang="cmake" linenumbers="False"
# Comments begins with #

# enable c++11
# enable c++11: if cmake version >= 3.8
target_compile_features(target_name PRIVATE cxx_std_11)

# enable c++11: if cmake version >= 3.1 
set_target_properties(target_name PROPERTIES CXX_STANDARD 11)

# enable c++11: cmake version >= 3.1 for all targets:
set (CMAKE_CXX_STANDARD 11)
set (CMAKE_CXX_STANDARD_REQUIRED ON)
# or set the variables from the command line with '-DCMAKE_CXX_STANDARD=11'

# to autodetect build for 32 or 64bit
if (${CMAKE_SIZEOF_VOID_P} MATCHES 8)
	# here is 64bits
else ()
	# here is 32bits
endif ()

}}}


===== Custom Lib =====
old but review: https://cmake.org/Wiki/CMake:How_To_Find_Libraries
XXX_INCLUDE_DIRS
XXX_LIBRARIES

CMAKE_PREFIX_PATH environment var

find_package() with version numbers will create variables with the user provided name but comparison is case sensitive:
user says: find_package(asdf)
package asdf is found and a variable is set asdf_VERSION
user says: find_package(ASDF)
same package is found and variable is set as ASDF_VERSION
for this reason there is needed some logic ...

If want to get latests versions, add these two lines before find_package
set(CMAKE_FIND_PACKAGE_SORT_ORDER NATURAL)
set(CMAKE_FIND_PACKAGE_SORT_DIRECTION DEC)


CXX_STANDARD requires cmake 3.1
project(DESCRIPTION) requires cmake 3.9

cmake generating files: https://crascit.com/2017/04/18/generated-sources-in-cmake-builds/

===== Visual studio =====

Regarding subsystem (console, windows) take a look at https://cmake.org/Wiki/VSConfigSpecificSettings

If using generated project files and need to **install** to copy `.dll` files,
run `cmake-gui` again and select the output folder as `CMAKE_INSTALL_PREFIX`
regenerate the project files then **build** `INSTALL` target on vs. 

Change run directory, 2 ways
1. Edit launch settings (Menu CMake -> Debug and Launch Settings -> name) add
'''
"currentDir": "${workspaceRoot}"
'''

2. Add to CMakeLists.txt (Cmake >= 3.8) **NOT WORKING**
'''
set_target_properties(<target> PROPERTIES
    VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_CURRENT_LIST_DIR}")
'''


===== External library example =====

SDL2, uncompress the VC file, create `sdl2-config.cmake` on that folder

{{{code: lang="cmake" linenumbers="False"
set(SDL2_INCLUDE_DIRS "${CMAKE_CURRENT_LIST_DIR}/include")

# Support both 32 and 64 bit builds
if (${CMAKE_SIZEOF_VOID_P} MATCHES 8)
  set(SDL2_LIBRARIES "${CMAKE_CURRENT_LIST_DIR}/lib/x64/SDL2.lib;${CMAKE_CURRENT_LIST_DIR}/lib/x64/SDL2main.lib")
else ()
  set(SDL2_LIBRARIES "${CMAKE_CURRENT_LIST_DIR}/lib/x86/SDL2.lib;${CMAKE_CURRENT_LIST_DIR}/lib/x86/SDL2main.lib")
endif ()

string(STRIP "${SDL2_LIBRARIES}" SDL2_LIBRARIES)
}}}

start cmake-gui, select the Source folder (where CMakeLists is), and the "binaries" (where the generated build files will be), then it will do some work and fail.

Note there is one SDL2_DIR, set it to the correct location (the one with the sdl2-config.cmake).

Configure other parameters if you want, the click generate.

==== Generating by command line ====

for 32bit:

	mkdir vs2017
	cd vs2017
	cmake -G "Visual Studio 15 2017" -D SDL2_DIR="c:\path\to\SDL2-X.X.X-VC" ..

for 64bit:

	mkdir vs2017-64
	cd vs2017-64
	cmake -G "Visual Studio 15 2017 Win64" -D SDL2_DIR="c:\path\to\SDL2-X.X.X-VC" ..


==== If on the other hand open directly on VisualStudio ====

//After basic tests, I don't like how VS behaves this way, better avoid//

**WARNING**: This seems doesn't work on vs2017 anymore, maybe my fault, check another way below.

Edit settings and add something like this to each configuration:
{{{code: lang="js" linenumbers="False"
"variables": [
	{
		"name": "SDL2_DIR",
		"value": "path\\to\\SDL2-X.X.X-VC"
	}
]
}}}


Another way after open the project is to right click on `CMakeLists.txt` and select **Change CMake Settings**,
then on the command args you can add what you need, like: `-DSDL2_DIR=path\\to\\SDL2`.

NOTE: Maybe only need to select menu **CMake** and **Change CMake Settings**.

Also, take into account that these builds go automatically to "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\build\\${name}" (the default on the settings) which is somewhere on your home.

If don't want some of the targets, select **Project -> Edit Settings -> CppProperties.json** and remove undesired ones, then close and open again folder.

==== External library on windows with mingw-w64 ====

Uncompress SDL2 for mingw and add this `sdl2-config.cmake` to its folder:
{{{code: lang="cmake" linenumbers="False"
# Support both 32 and 64 bit builds
if (${CMAKE_SIZEOF_VOID_P} MATCHES 8)
  set(SDL2_BASE "${CMAKE_CURRENT_LIST_DIR}/x86_64-w64-mingw32")
else ()
  set(SDL2_BASE "${CMAKE_CURRENT_LIST_DIR}/i686-w64-mingw32")
endif ()

set(SDL2_INCLUDE_DIRS "${SDL2_BASE}/include/SDL2")
set(SDL2_LIBRARIES "-L${SDL2_BASE}/lib -lmingw32 -lSDL2main -lSDL2 -mwindows")

string(STRIP "${SDL2_LIBRARIES}" SDL2_LIBRARIES)
}}}


Then to use it
{{{code: lang="cmake" linenumbers="False"
find_package(SDL2 REQUIRED)
target_include_directories(targetname PRIVATE ${SDL2_INCLUDE_DIRS})
target_link_libraries(targetname ${SDL2_LIBRARIES})
}}}

When generating the makefiles, it runs better from command line, need to add the SDL2_DIR variable so cmake can find it

1. Make sure the _mingw-w64_ you want is on the `PATH`
2. Create a directory to hold the resulting makefiles and binary, preffer a directory different from the base of your source code.
3. Run command adding the corect `SDL2_DIR`:

	cmake -G "MinGW Makefiles" -D "SDL2_DIR=C:\path\to\SDL2-2.X.X-mingw" path\to\source

4. Run `mingw32-make`

==== external library on windows for msvc and mingw ====

Having prepared the two previous `sdl2-config.cmake` with a common parent folder, add another `sdl2-config.cmake` there, for example:

* SDL2-2.0.7
	* SDL2-2.0.7-VC
	* SDL2-2.0.7-mingw
	* sdl2-config.cmake

The new `sdl2-config.cmake` just forwards to the correct one depending on the compiler used.
{{{code: lang="cmake" linenumbers="True"
if ( MINGW )
	include( ${CMAKE_CURRENT_LIST_DIR}/SDL2-2.0.7-mingw/sdl2-config.cmake)
elseif ( MSVC )
	include( ${CMAKE_CURRENT_LIST_DIR}/SDL2-2.0.7-VC/sdl2-config.cmake)
endif ()
}}}


==== find_package on windows ====

Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Kitware\CMake\Packages\ffmpeg

Add key to registry (SDL2 as package example)
`HKEY_LOCAL_MACHINE\SOFTWARE\Kitware\CMake\Packages\SDL2` set default value to
path with the `.cmake` file.

Can be HKEY_LOCAL_MACHINE or HKEY_CURRENT_USER.

==== find_package linux for user packages ====

Save the path to the `.cmake` file on a file with any name located on:

~/.cmake/packages/<package_name>/

==== force 32bit on mingw-w64 ====

Some versions doesn't support both 32 and 64 bit, for the ones that does, you need to create a _platform file_:
https://stackoverflow.com/questions/5805874/the-proper-way-of-forcing-a-32-bit-compile-using-cmake

Other versions you need to have 2 compilers, one for 64 and one for 32. When creating the builds,
add the compiler you want to use to `PATH` (for example 32 bit) and creste the build. Example:

	mkdir build32
	cd build32
	PATH path/to/i686-mingw-w64/bin;%PATH%
	cmake ..

	(in another terminal)
	mkdir build64
	cd build64
	PATH path/to/x86_64-mingw-w64/bin;%PATH%
	cmake ..

Now you can build any version from the base folder

	cmake --build build32
	cmake --build build64


===== Install target =====
{{{code: lang="cmake" linenumbers="True"
install(TARGET targetname ARCHIVE DESTINATION some/path)
install(DIRECTORY dir_name/ DESTINATION some/path)
}}}


**IMPORTANT**: note the '/' at the end of `DIRECTORY dir_name/`, if you don't add it, the contents will be copied to `some/path/dir_name` which you may or may not want.

On linux, if wants to install somewhere else than default (/usr/local), regenerate with different prefix:

	cmake -D CMAKE_INSTALL_PREFIX=/ <source_dir>

Then when install add DESTDIR

	make install DESTDIR=some/other/folder


===== Netbeans =====

When creating a project with existing sources with cmake, select custom, then you can use a different directory for the build. If you don't do like this, the cmake files will polute you base folder.

===== RPATH =====

**RPATH** will be written by default including all libraries cmake thinks it needs, this is good for developing. When you **install** it can be replaced:
{{{code: lang="cmake" linenumbers="True"
set_target_properties(target_name PROPERTIES INSTALL_RPATH "$ORIGIN/lib")
}}}


===== mingw =====

If not on path, before running cmake add your desired mingw/bin to path

===== Code::Blocks =====

Generate project

	cmake -G "CodeBlocks - MinGW Makefiles" path/to/source

Then within CodeBlocks there will be several targets.

IMPORTANT: For the special targets, use **build** button and not the **run** button.

edit_cache -> will launch `cmake-gui` to reconfigure
install -> will run `make install`, change destination by `edit_cache`

==== Generated Targets ====

target_name: The normal build procedure
target_name/fast: Build procedure without checking external dependencies
install: The normal install
install/strip: Installs and strip the binaries
install/local: _Need to check_


===== more notes =====

CMAKE_PREFIX_PATH=/my/path/to/base

CMAKE_PREFIX_PATH/lib/cmake/<names>
